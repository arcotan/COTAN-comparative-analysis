
---
  title: "Probability score computation"
---

```{r}
library(rlang)
library(testthat)
library(ggplot2)
library(tibble)
library(zeallot)
library(Seurat)
library(aricode)
library(funtimes)
library(monocle3)
library(cluster)
library(COTAN)

labelsPath = './data/PBMC1/monocle/default/clustering_labels.csv'
celltypistPath = './data/PBMC1/celltypist/Immune_All_Low_probability_matrix.csv'
```

Load CellTypist clusterization

```{r}
probMatrixDF <- read.csv(celltypistPath, header = TRUE)
probMatrixDF <- column_to_rownames(probMatrixDF, var = "X")
rownames(probMatrixDF) <- gsub("[.]", ":", rownames(probMatrixDF))
rownames(probMatrixDF) <- gsub("X10X", "10X", rownames(probMatrixDF))
rownames(probMatrixDF) <- substr(rownames(probMatrixDF), 1, nchar(rownames(probMatrixDF)) - 2)
```

Estimate number of dimensions

```{r}
prc <- PCAtools::pca(mat = probMatrixDF, rank = 50, transposed = TRUE)
plot(prc$sdev)
```

```{r}
nDims <- 20
```

Calculate the projection to spherical distribution [Malahanobis distance]:
the sum of square distances from center of sub-cluster in pca-projected space

```{r}
averageClustersDistance <- function(probMatrixDF,
                                    clustersList, numDim = 20L) {
  pca <- PCAtools::pca(mat = probMatrixDF, rank = nDims, transposed = TRUE)

  print(paste("Residual variance percentage: ", 100 - sum(pca[["variance"]])))

  normMatrix <- scale(x = pca[["rotated"]], center = TRUE, scale = TRUE)
  rownames(normMatrix) <- rownames(probMatrixDF)

  print(paste("Final dimensions:", paste0(dim(normMatrix), collapse = ", ")))

  squareDist <- function(subMatrix) {
    subMatrix <- scale(subMatrix, scale = FALSE, center = TRUE)
    return(sum(rowSums(subMatrix^2)))
  }
  sumDist <- 0.0
  for (cl in clustersList) {
    sumDist <- sumDist + squareDist(normMatrix[cl, , drop = FALSE])
  }
  return(sumDist / ncol(normMatrix) / (nrow(normMatrix) - length(clustersList)))
}
```

```{r}
labels <- read.csv(labelsPath, header = TRUE)
clustersList<- split(as.character(labels$cell), labels$cluster)
averageClustersDistance(probMatrixDF, clustersList)
```

